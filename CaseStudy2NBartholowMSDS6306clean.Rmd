---
title: "Craft Beer Market Analysis"
author: "Nicole Bartholow"
date: "10/20/2018"
output: pdf_document
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(DataExplorer)
library(dplyr)
library(plyr)
library(ggplot2)
library(openintro)
library(reshape2)
library(gridExtra)
library(grid)
library(mlr)
library(caret)
library(class)

tidyverse_conflicts()
```

#Introduction


</p>


####First we bring in the data provided and clean it up for analysis.  
####The current population data 
```{r Read Attrition Data}
#set working directory for local computer
#REPRODUCIBLE TIP - CHANGE THIS WORKING DIRECTORY FOR YOUR REPRODUCTION ENVIRONMENT

PATH <- "/Users/Chase/Desktop/MSDS/CaseStudy2data.csv"
PATH2 <- "/Users/Chase/Desktop/MSDS/CaseStudy2Validation.csv"


CS2Data <- read.csv(PATH, header = TRUE) #import HR Data into CS2Data dataframe
CS2Val <- read.csv(PATH2, header = TRUE) #import HR Validation Set into CS2Val dataframe

```

#Analysis of missing/unneccesary data
```{r}
EmptyCols <- colSums(is.na(CS2Data))#Check for NA - zero NA fields

#Remove columns that are irrelevant or have only one value
#Feel free to clean this ugliness 
#This was the cleanest way I knew to get rid of several specific columns not next to each other
CS2DataRelevant <- CS2Data[,-10] #remove Employee Count
CS2DataRelevant <- CS2DataRelevant[,-22] #remove Over18 - always Yes
CS2DataRelevant <- CS2DataRelevant[,-26] #remove StandardHours - always 80
CS2DataRelevant <- CS2DataRelevant[,-34] #remove Rand

#Make test and train the same
CS2ValRel <- CS2Val[,-10] #remove Employee Count
CS2ValRel <- CS2ValRel[,-22] #remove Over18
CS2ValRel <- CS2ValRel[,-26] #remove StandardHours
CS2ValRel <- CS2ValRel[,-34] #remove Rand


CS2DataRelevant <- within(CS2DataRelevant, {
  Gender.Ch <- C(Gender, treatment)
  print(attributes(Gender.Ch))
})

CS2DataRelevant <- within(CS2DataRelevant, {
  OverTime.Ch <- C(OverTime, treatment)
  print(attributes(OverTime.Ch))
})

#Turn Factors into integers 
CS2DataRelevant$OTInt <- as.integer(CS2DataRelevant$OverTime)
CS2DataRelevant$GenderInt <- as.integer(CS2DataRelevant$Gender)

head(CS2DataRelevant)


```

```{r Attrition with Income/Rates Graphs}
## The following plots compare Income rates given with Attrition
g1 <- ggplot(CS2DataRelevant, aes(x = MonthlyIncome, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#fdb462"))

g2 <- ggplot(CS2DataRelevant, aes(x = MonthlyRate, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#fdb462"))

g3 <- ggplot(CS2DataRelevant, aes(x = HourlyRate, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#fdb462"))

g4 <- ggplot(CS2DataRelevant, aes(x = DailyRate, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#fdb462"))

OTg <- ggplot(CS2DataRelevant, aes(x = OTInt, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#fdb462"))

## Box Plot of Job Roles compared to OT grouped by Attrition 
OTg2 <- ggplot(CS2DataRelevant, aes(x = JobRole, y = OTInt, fill = Attrition)) + geom_bar(stat = "identity") + scale_fill_manual(values = c("#386cb0", "#ffa500")) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip()

grid.arrange(g1, g2, g3, g4, OTg, OTg2, ncol = 2, nrow = 3)

```
```{r Attrition More Graphs}
## Total Counts of Attrition Yes VS No
g6 <- ggplot(CS2DataRelevant, aes(x = Attrition)) + geom_histogram(stat="count", position = "stack", fill = c("#386cb0","#ffa500"))

## Distance from home related to Attrition Density
g1 <- ggplot(CS2DataRelevant, aes(x = DistanceFromHome, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#ffa500"))

## Job Satisfaction related to Attrition Density
g2 <- ggplot(CS2DataRelevant, aes(x = JobSatisfaction, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#ffa500"))

## Percentage of Salary Hike related to Attrition Density
g3 <- ggplot(CS2DataRelevant, aes(x = PercentSalaryHike, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#ffa500"))

## Environment Satisfaction related to Attrition Density
g4 <- ggplot(CS2DataRelevant, aes(x = EnvironmentSatisfaction, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#ffa500"))

## Work Life Balance related to Attrition Density
g7 <- ggplot(CS2DataRelevant, aes(x = WorkLifeBalance, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#ffa500"))

## Years at the company related to Attrition Density
g8 <- ggplot(CS2DataRelevant, aes(x = YearsAtCompany, fill = Attrition)) + geom_density(alpha = 0.5) + scale_fill_manual(values = c("#386cb0", "#ffa500"))


grid.arrange(g1, g2, g3, g4, g7, g8, ncol = 2, nrow = 3)

## Count of Attrition Stacked by Job Role
g5 <- ggplot(CS2DataRelevant, aes(x = JobRole, fill = Attrition)) + geom_histogram(stat="count", position = "stack") + scale_fill_manual(values = c("#386cb0", "#ffa500")) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

## Box Plot of Job Roles compared to Monthly Income grouped by Attrition 
ggplot(CS2DataRelevant, aes(JobRole, MonthlyIncome,  fill = Attrition)) + geom_boxplot(alpha = 0.5) + coord_flip() + scale_fill_manual(values = c("#386cb0", "#ffa500"))

grid.arrange(g5, g6, ncol = 2, nrow = 1)

```

```{r}
library(GoodmanKruskal)
library(corrplot)

varset1 <- c("Attrition", "BusinessTravel", "Department", "EducationField", "Gender", "MaritalStatus","JobRole")
CatFrame <- subset(CS2DataRelevant, select = varset1)
GKmatrix1 <- GKtauDataframe(CatFrame)
plot(GKmatrix1, corrColors = "blue")

```


#EDA/PCA
```{r}
plot_str(CS2Data)
plot_histogram(CS2Data)

#Boxplots of each continuous variable against Attrition
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = Age)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = JobSatisfaction)) +
  geom_boxplot() #JobSatisfaction of 1
#Continuous variable needs a different visual
#ggplot(data = CS2Data, mapping = aes(x = Attrition, y = BusinessTravel)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = DailyRate)) +
  geom_boxplot()
#Continuous variable needs a different visual
#ggplot(data = CS2Data, mapping = aes(x = Attrition, y = Department)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = DistanceFromHome)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = Education)) +
  geom_boxplot()
#Continuous variable needs a different visual
#ggplot(data = CS2Data, mapping = aes(x = Attrition, y = EducationField)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = EnvironmentSatisfaction)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = Gender)) +
  geom_boxplot() #EnvoronmentSatisfaction=1
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = HourlyRate)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = JobInvolvement)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = JobLevel)) +
  geom_boxplot()#level 1
#Continuous variable needs a different visual
#ggplot(data = CS2Data, mapping = aes(x = Attrition, y = JobRole)) +
  geom_boxplot()
#ggplot(data = CS2Data, mapping = aes(x = Attrition, y = MaritalStatus)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = MonthlyIncome)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = MonthlyRate)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = NumCompaniesWorked)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = PercentSalaryHike)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = PerformanceRating)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = RelationshipSatisfaction)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = StockOptionLevel)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = TotalWorkingYears)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = TrainingTimesLastYear)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = WorkLifeBalance)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = YearsAtCompany)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = YearsInCurrentRole)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = YearsSinceLastPromotion)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = YearsWithCurrManager)) +
  geom_boxplot()
ggplot(data = CS2Data, mapping = aes(x = Attrition, y = OverTime)) +
  geom_boxplot()
```


```{r}
#Logistic Regression for Competition
model <- glm(formula = Attrition ~ ., family = binomial(link = "logit"), data = CS2DataRelevant)
summary(model)



#Turn Factors into integers 
CS2DataRelevant$OTInt <- as.integer(CS2DataRelevant$OverTime)
#CS2DataRelevant$AttInt <- as.integer(CS2DataRelevant$Attrition)
CS2ValRel$OTInt <- as.integer(CS2Val$OverTime)
CS2Val$AttInt <- as.integer(CS2Val$Attrition)


#kNN for Attrition
#make the models the same

#k = 34 (Square root of number of observations in training set) Overall Accuracy .8367
results34 <- class::knn(CS2DataRelevant[,c(10, 20, 33)], CS2ValRel[,c(10, 20, 33)], CS2DataRelevant$Att, k=34)
CS2ValRel$AttPred34 <- results34
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred34))

#k = 5 Overall Accuracy 0.83
results5 <- class::knn(CS2DataRelevant[,c(10, 20, 33)], CS2ValRel[,c(10, 20, 33)], CS2DataRelevant$Att, k=5)
CS2ValRel$AttPred5 <- results5
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred5))

#k = 10 Overall Accuracy 0.8333
results10 <- class::knn(CS2DataRelevant[,c(10, 20, 33)], CS2ValRel[,c(10, 20, 33)], CS2DataRelevant$Att, k=10)
CS2ValRel$AttPred10 <- results10
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred10))

#k = 20 Overall Accuracy 0.8333
results20 <- class::knn(CS2DataRelevant[,c(10, 20, 33)], CS2ValRel[,c(10, 20, 33)], CS2DataRelevant$Att, k=20)
CS2ValRel$AttPred20 <- results20
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred20))



#k = 30 0Overall Accuracy Overall Accuracy .8367
results30 <- class::knn(CS2DataRelevant[,c(10, 20, 33)], CS2ValRel[,c(10, 20, 33)], CS2DataRelevant$Att, k=30)
CS2ValRel$AttPred30 <- results30
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred30))

#k = 37 0Overall Accuracy Overall Accuracy .8367
results37 <- class::knn(CS2DataRelevant[,c(10, 20, 33)], CS2ValRel[,c(10, 20, 33)], CS2DataRelevant$Att, k=37)
CS2ValRel$AttPred37<- results37
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred37))
#k = 33 0Overall Accuracy Overall Accuracy .8367
results33 <- class::knn(CS2DataRelevant[,c(10, 20, 33)], CS2ValRel[,c(10, 20, 33)], CS2DataRelevant$Att, k=33)
CS2ValRel$AttPred33<- results33
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred33))
#k = 35 0Overall Accuracy Overall Accuracy .8367
results35 <- class::knn(CS2DataRelevant[,c(10, 20, 33)], CS2ValRel[,c(10, 20, 33)], CS2DataRelevant$Att, k=35)
CS2ValRel$AttPred35<- results35
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred35))

#k = 70 Overall Accuracy Overall Accuracy .8367
results45 <- class::knn(CS2DataRelevant[,c(10, 20, 33)], CS2ValRel[,c(10, 20, 33)], CS2DataRelevant$Att, k=70)
CS2ValRel$AttPred45<- results45
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred45))
```

```{r This part does not work for me}
#Try with additional variables - does not improve accuracy over .8367
#k = 34 (Square root of number of observations in training set) Overall Accuracy .8367
results34 <- class::knn(CS2DataRelevant[,c(10, 13, 16, 20, 33)], CS2ValRel[,c(10, 13, 16, 20, 33)], CS2DataRelevant$Att, k=34)
CS2ValRel$AttPred34 <- results34
confusionMatrix(table(CS2ValRel$Attrition,CS2ValRel$AttPred34))


```

```{r}
#knn Regression for Attrition - what does it look like when we make the prediction a conitnuous variable?
#fit3 = knnreg(x = CS2DataRelevant[, c(10, 20, 33)], y = CS2DataRelevant$Att, k=3)
#PredsTest3 <-predict(fit3, CS2Val[,c(12, 22, 38)])
#ASETestAtt3 = sum((PredsTest3 - CS2Val$AttInt)^2)/(length(CS2Val$Att))


#Logistic Regression for Competition
#create a dataset for prediction


CS2LRModel <- data.frame(cbind(CS2DataRelevant$ID, CS2DataRelevant$Attrition, CS2DataRelevant$OverTime, CS2DataRelevant$EnvironmentSatisfaction, CS2DataRelevant$NumCompaniesWorked, CS2DataRelevant$JobInvolvement, CS2DataRelevant$BusinessTravel, CS2DataRelevant$YearsSinceLastPromotion, CS2DataRelevant$JobSatisfaction))
CS2LRModel$Attrition <- CS2LRModel$Attrition - 1

colnames(CS2LRModel) <- c('ID', 'Attrition', 'OverTime', 'EnvironmentSatisfaction', 'NumCompaniesWorked', 'JobInvolvement', 'BusinessTravel', 'YearsSinceLastPromotion', 'JobSatisfaction')

model <- glm(formula = Attrition ~ ., family = binomial(link = "logit"), data = CS2LRModel)
summary(model)
model <- glm(formula = Attrition ~  OverTime+EnvironmentSatisfaction + NumCompaniesWorked + JobInvolvement + BusinessTravel + YearsSinceLastPromotion + JobSatisfaction, family = binomial(link = "logit"), data = CS2LRModel)
summary(model)

CS2LRModel <- CS2LRModel[,-7] #remove 'YearsSinceLastPromotion', 'JobSatisfaction'
CS2LRModel <- CS2LRModel[,-7] #remove 'YearsSinceLastPromotion', 'JobSatisfaction'

model <- glm(formula = Attrition ~  OverTime+EnvironmentSatisfaction + NumCompaniesWorked + JobInvolvement , family = binomial(link = "logit"), data = CS2LRModel)
summary(model)
```


###Github Respository
####https://github.com/NicoleABartholow/MSDS6306CaseStudy2



